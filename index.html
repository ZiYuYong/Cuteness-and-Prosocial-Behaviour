<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Zoo Study - Kindchenschema and Kindness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            font-size: 2rem;
            opacity: 0.1;
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-30px) rotate(180deg);
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        .section.hidden {
            display: none;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            color: white;
            font-size: 3rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 255, 255, 0.2);
            }

            to {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.4);
            }
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.3rem;
            font-weight: 300;
        }

        h1,
        h2,
        h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        h1 {
            font-size: 2.5rem;
            text-align: center;
        }

        h2 {
            font-size: 1.8rem;
            color: #764ba2;
        }

        h3 {
            font-size: 1.3rem;
        }

        p,
        li {
            color: white;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .highlight {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin: 1.5rem 0;
    box-shadow: 0 15px 30px rgba(240, 147, 251, 0.3);
    text-align: center;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
}

        .info-box {
            background: rgba(103, 126, 234, 0.1);
            border-left: 5px solid #667eea;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 15px 15px 0;
            backdrop-filter: blur(5px);
        }

        .navigation-buttons .btn {
            flex: 1;
            max-width: 250px;
            min-width: 160px;
        }

        .navigation-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-top: 2rem;
            padding: 0 1rem;
        }

        .btn-standalone {
            max-width: 300px;
            margin: 0 auto;
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            pointer-events: none;
        }

        .btn-back {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-back:hover {
            box-shadow: 0 15px 35px rgba(108, 117, 125, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }

        .btn:hover::before {
            animation: shine 0.6s ease-in-out;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
                opacity: 0;
            }
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 1rem;
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .radio-group,
        .checkbox-group {
            display: grid;
            gap: 1rem;
            margin-left: 1rem;
        }

        .radio-group label,
        .checkbox-group label {
            font-weight: normal;
            cursor: pointer;
            padding: 1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(248, 249, 250, 0.8);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
        }

        .radio-group label:hover,
        .checkbox-group label:hover {
            background: rgba(103, 126, 234, 0.1);
            border-color: rgba(103, 126, 234, 0.3);
            transform: translateX(5px);
        }

        input[type="radio"],
        input[type="checkbox"] {
            margin-right: 1rem;
            transform: scale(1.3);
            cursor: pointer;
        }

        .age-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .zoo-entrance {
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
            border-radius: 25px;
            padding: 3rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .zoo-entrance::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .zoo-gate {
            font-size: 6rem;
            margin: 2rem 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-20px);
            }

            60% {
                transform: translateY(-10px);
            }
        }

        .enter-zoo-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            font-size: 1.3rem;
            padding: 1.5rem 3rem;
            margin: 2rem;
            animation: pulse 2s infinite;
        }

        .enter-zoo-btn:hover {
            box-shadow: 0 20px 40px rgba(40, 167, 69, 0.4);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .zoo-encounter {
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
            border-radius: 25px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .animal-image {
            max-width: 400px;
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease;
        }

        .animal-image:hover {
            transform: scale(1.05) rotate(1deg);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .donation-section {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 3px solid rgba(103, 126, 234, 0.1);
        }

        .slider-container {
            margin: 2rem 0;
            position: relative;
        }

        .slider {
            width: 100%;
            height: 15px;
            border-radius: 8px;
            background: linear-gradient(to right, #e9ecef 0%, #667eea 100%);
            outline: none;
            -webkit-appearance: none;
            margin: 1.5rem 0;
            position: relative;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.3);
            box-shadow: 0 12px 25px rgba(102, 126, 234, 0.6);
        }

        .slider::-moz-range-thumb {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .slider-values {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            color: #666;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .donation-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.3);
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.3);
            height: 15px;
            border-radius: 8px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            height: 100%;
            width: 0%;
            transition: width 0.6s ease;
            border-radius: 8px;
        }

        .progress-text {
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .likert-scale {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin: 2rem 0;
            text-align: center;
        }

        .likert-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 1rem;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(248, 249, 250, 0.8);
            border: 2px solid transparent;
        }

        .likert-item:hover {
            background: rgba(103, 126, 234, 0.1);
            border-color: rgba(103, 126, 234, 0.3);
            transform: translateY(-5px);
        }

        .likert-item input[type="radio"] {
            margin-bottom: 1rem;
            transform: scale(1.5);
        }

        .likert-item label {
            font-size: 0.9rem;
            font-weight: normal;
            text-align: center;
            line-height: 1.3;
        }

        .attention-check-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .attention-image-item {
            text-align: center;
            padding: 1.5rem;
            border-radius: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(248, 249, 250, 0.8);
            border: 3px solid transparent;
        }

        .attention-image-item:hover {
            background: rgba(103, 126, 234, 0.1);
            border-color: rgba(103, 126, 234, 0.3);
            transform: translateY(-8px);
        }

        .attention-image-item img {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .attention-image-item:hover img {
            transform: scale(1.05);
        }

        .error-message {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1.5rem 0;
            text-align: center;
            font-weight: bold;
            animation: shake 0.6s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-8px);
            }

            75% {
                transform: translateX(8px);
            }
        }

        .success-message {
            background: linear-gradient(135deg, #51cf66 0%, #69db7c 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
            text-align: center;
            font-weight: bold;
        }

        .thank-you-page {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 25px;
            color: white;
        }

        .thank-you-page h1 {
            color: white;
            font-size: 3rem;
            margin-bottom: 2rem;
        }

        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(103, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            border: 2px solid rgba(103, 126, 234, 0.2);
            backdrop-filter: blur(5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
            font-weight: 500;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .section {
                padding: 1.5rem;
            }

            .likert-scale {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .attention-check-grid {
                grid-template-columns: 1fr;
            }

            .animal-image {
                max-width: 100%;
                height: 280px;
            }

            .stats-display {
                grid-template-columns: 1fr;
            }

            .navigation-buttons {
                flex-direction: row;
                gap: 1rem;
            }

            .navigation-buttons .btn {
                min-width: 120px;
                max-width: 200px;
            }

            .age-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .zoo-gate img {
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="floating-elements">
        <div class="floating-element" style="top: 15%; left: 10%; animation-delay: 0s;">🦁</div>
        <div class="floating-element" style="top: 25%; right: 15%; animation-delay: 1.5s;">🐧</div>
        <div class="floating-element" style="top: 65%; left: 20%; animation-delay: 3s;">🐙</div>
        <div class="floating-element" style="top: 75%; right: 25%; animation-delay: 4.5s;">🐵</div>
        <div class="floating-element" style="top: 45%; left: 60%; animation-delay: 6s;">🦒</div>
        <div class="floating-element" style="top: 35%; right: 40%; animation-delay: 7.5s;">🐠</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🦁 Virtual Zoo Research Study 🦁</h1>
            <p>Kindchenschema and Kindness: The Role of Cuteness in Prosocial Behaviour</p>
        </div>

        <div class="section" id="informed-consent">
            <h1>📋 Informed Consent</h1>
            <p><strong>Dear Participant,</strong></p>
            <p>Welcome to participate in the study titled <strong>"Kindchenschema and Kindness: The Role of Cuteness in
                    Prosocial Behaviour"</strong>. Should you have any questions regarding this study, feel free to
                direct them to the researcher. The details are available in this consent form.</p>

            <h3>🔬 Description of the project:</h3>
            <p>This study aims to investigate the effect of cuteness on prosocial behaviour. To take part in this study,
                you must age between 18 and 25 years old. In addition, you should not have any visionary problems.</p>

            <h3>📝 What will be done:</h3>
            <p>If you agree to participate, you will first complete an informed consent form and a short demographic
                questionnaire. If you agree to participate, you will first complete an informed consent form and a short 
                demographic questionnaire. After that, you will take part in a zoo-themed Dictator Game task.
                In this task, you are required to pay an entrance fee of RM140, which will be converted 
                into 140 tokens (1 token = RM1). You will then visit 14 animals in total, and for each animal you will be 
                given 10 tokens from this entrance fee to allocate.  
                
                Your job is to decide: 
                1. How many tokens to donate to the animal for its food and medical care. 
                2. How many tokens to keep for yourself.

                You may choose any whole number between 0 and 10 tokens. At the end of the task, all the tokens you kept across 
                the 14 animals will be described as being refunded to you in cash (RM). 
                The entire study will take no longer than 30 minutes to complete.</p>

            <h3>⚠️ Risks or discomfort:</h3>
            <p>There is no foreseeable risk or discomfort from this study. If you find your participation in this study
                has caused you to experience any psychological harm, you may contact the Centre for Psychological and
                Counselling Services (CPCS) at cpcs.hu@help.edu.my or dial 03-78493200 to make an appointment or visit
                any reputable counselling centres near you. Please note that CPCS sees clients only on an appointment
                basis.</p>

            <div class="info-box">
                <strong>Centre for Psychological & Counselling Services (CPCS)</strong><br>
                Level 6, Block B,<br>
                HELP University Subang 2,<br>
                Persiaran Cakerawala, Seksyen U4,<br>
                40150 Shah Alam, Selangor.<br>
                Tel: 03-7849 3200<br>
                Email: cpcs.hu@help.edu.my
            </div>

            <h3>🎁 Benefits of this study:</h3>
            <p>There will be no compensation for participating in this study. However, your participation will help
                advance the current understanding of the effect of cuteness on prosocial behaviour.</p>

            <h3>🔒 Confidentiality:</h3>
            <p>We will take every effort to ensure that any information collected from you remains confidential. Only
                the researcher and the researcher's supervisor will be able to access the information gathered.</p>

            <h3>🚪 Decision to quit at any time:</h3>
            <p>Participation in this study is voluntary based. You reserve the right to withdraw at any time, with no
                adverse actions being implemented. If you wish to terminate participation, please exit the experiment
                without submitting your responses.</p>

            <h3>📋 Rights and complaints:</h3>
            <p>This study has been reviewed and approved by the Ethics Review Board, Department of Psychology, Faculty
                of Behavioural Sciences at HELP University [ERB Approval Code: ]. For any research-related problems,
                complaints, or questions regarding participants' rights, please contact the Chairperson of the Ethics
                Review Board.</p>

            <div class="info-box">
                <strong>Chairperson, Ethics Review Board</strong><br>
                Department of Psychology<br>
                Faculty of Behavioural Sciences<br>
                Level 3, Block B HELP University -- Subang 2<br>
                Persiaran Cakerawala, Seksyen U4<br>
                40150 Shah Alam<br>
                Selangor Darul Ehsan Malaysia<br>
                Email: psych.erb@help.edu.my<br>
                Phone: +603 7849 3000
            </div>

            <p>For any enquiries about this particular study, please feel free to contact the researcher:</p>

            <div class="info-box">
                <strong>Researcher:</strong> Yong Zi Yu - B2100815@helplive.edu.my<br>
                <strong>Research Supervisor:</strong> Ms. Khor Khai Ling - khailing.k@help.edu.my
            </div>

            <div class="highlight">
                <h3>✅ By clicking the button below, you acknowledge:</h3>
                <p>Your participation in the study is voluntary.</p>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-primary" onclick="proceedToSection('demographics')">I consent</button>
                <button class="btn btn-back" onclick="handleNonConsent()">Do not consent</button>
            </div>
        </div>

        <div class="section hidden" id="demographics">
            <h1>👤 Demographic Information</h1>
            <p>Please provide the following information to determine your eligibility for this study.</p>

            <div class="form-group">
                <label>🎂 What is your age?</label>
                <div class="radio-group age-grid">
                    <label><input type="radio" name="age" value="18"> 18</label>
                    <label><input type="radio" name="age" value="19"> 19</label>
                    <label><input type="radio" name="age" value="20"> 20</label>
                    <label><input type="radio" name="age" value="21"> 21</label>
                    <label><input type="radio" name="age" value="22"> 22</label>
                    <label><input type="radio" name="age" value="23"> 23</label>
                    <label><input type="radio" name="age" value="24"> 24</label>
                    <label><input type="radio" name="age" value="25"> 25</label>
                    <label><input type="radio" name="age" value="others"> Others</label>
                </div>
            </div>

            <div class="form-group">
                <label>👥 What is your gender?</label>
                <div class="radio-group">
                    <label><input type="radio" name="gender" value="male"> Male</label>
                    <label><input type="radio" name="gender" value="female"> Female</label>
                    <label><input type="radio" name="gender" value="non-binary"> Non-binary/Third gender</label>
                    <label><input type="radio" name="gender" value="prefer-not-to-say"> Prefer not to say</label>
                </div>
            </div>

            <div class="form-group">
                <label>🌍 What is your nationality?</label>
                <div class="radio-group">
                    <label><input type="radio" name="nationality" value="malaysian"> Malaysian</label>
                    <label><input type="radio" name="nationality" value="non-malaysian"> Non-Malaysian</label>
                </div>
            </div>

            <div class="form-group">
                <label>👁️ Vision Conditions</label>
                <p style="font-size: 1rem; color: #666; margin-bottom: 1rem;">
                    Do you have any vision-related conditions that may affect your ability to view images clearly (e.g.,
                    myopia, astigmatism, short-sightedness, long-sightedness, blurry vision, colour blindness,
                    etc)?<br><br>
                    <em>*Corrected vision = You have a vision issue, but you wear glasses or contact lenses that help
                        you see clearly</em><br>
                    <em>*Uncorrected vision = You have a vision issue, but you don't wear glasses or contact lenses, so
                        your vision is still blurry or unclear</em>
                </p>
                <div class="radio-group">
                    <label><input type="radio" name="vision" value="no-condition"> ✅ No, I don't have any vision-related
                        condition</label>
                    <label><input type="radio" name="vision" value="corrected"> 👓 Yes, but corrected with glasses or
                        contact lenses</label>
                    <label><input type="radio" name="vision" value="uncorrected"> ❌ Yes, uncorrected</label>
                    <label><input type="radio" name="vision" value="prefer-not-to-say"> 🤐 Prefer not to say</label>
                </div>
            </div>

            <div id="demographics-error" class="error-message hidden"></div>

            <div class="navigation-buttons">
                <button class="btn btn-back" onclick="proceedToSection('informed-consent')">⬅️ Back</button>
                <button class="btn btn-primary" onclick="validateDemographics()">✅ Continue to Study</button>
            </div>
        </div>

        <div class="section hidden" id="zoo-entrance">
            <div class="zoo-entrance">
                <h1 style="color: #6B7EF7; font-size: 3rem; margin-bottom: 2rem;">🎪 Welcome to Our Virtual Zoo! 🎪</h1>

                <div class="zoo-gate"
                    style="margin: 3rem 0; display: flex; justify-content: center; align-items: center;">
                    <img src="https://i.imgur.com/wTReFzy.jpeg" alt="Zoo Entrance"
                        style="max-width: 500px; width: 100%; height: auto; border-radius: 15px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); transition: transform 0.3s ease;"
                        onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                </div>

                <p style="font-size: 1.2rem; margin-bottom: 2rem;">You're about to embark on an amazing virtual zoo
                    adventure!</p>

                <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Zoo Instructions</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .highlight h3 {
            margin-top: 0;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .highlight p {
            margin-bottom: 15px;
        }
        
        .highlight strong {
            font-weight: 700;
            color: #ffeb3b;
        }
        
        .highlight em {
            color: #4fc3f7;
            font-style: italic;
        }
        
        ul {
            padding-left: 20px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .section-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="highlight">
        <h3>🎯 Welcome to the Virtual Zoo!</h3>
        
        <p>In this study, you will receive a <em><strong>virtual zoo ticket</strong></em> worth <strong>RM140</strong>, which is converted into <strong>140 tokens</strong> (1 token = RM1). This amount is provided by the research team — you do not need to pay anything.</p>
        
        <div class="section-title">Your Task</div>
        <ul>
            <li>You will "visit" <strong>14 animals</strong> in total.</li>
            <li>For each animal, you are given <strong>10 tokens</strong> from your 140 tokens.</li>
            <li>You must decide how many of the 10 tokens to:
                <ol style="margin-top: 8px;">
                    <li><strong>Donate</strong> to the animal for its food and medical care, and</li>
                    <li><strong>Keep</strong> for yourself.</li>
                </ol>
            </li>
        </ul>
        
        <div class="section-title">Example</div>
        <ul>
            <li>If you donate <strong>4 tokens</strong>, you keep <strong>6 tokens</strong>.</li>
            <li>If you donate <strong>0 tokens</strong>, you keep all <strong>10 tokens</strong>.</li>
            <li>If you donate <strong>10 tokens</strong>, you keep <strong>0 tokens</strong>.</li>
        </ul>
        
        <div class="section-title">What Happens to Your Tokens</div>
        <ul>
            <li>At the end of the visit, any tokens you keep will be <strong>refunded to you in cash (RM)</strong> at the same rate of <strong>1 token = RM1</strong>.</li>
        </ul>
        
        <div class="section-title">Important Notes</div>
        <ul>
            <li>The RM140 ticket is <strong>provided by the study</strong>. You do not need to make any payment.</li>
            <li>There are <strong>no right or wrong answers</strong> — please decide based on how you feel.</li>
            <li>All decisions are <strong>confidential</strong> and will not be shown to other participants.</li>
        </ul>
    </div>
</body>
</html>

                <p style="font-size: 1.1rem; color: #666;">After finishing all the animals, we'll show the total amount
                    you "spent" on the animals.</p>

                <button class="btn enter-zoo-btn btn-standalone" onclick="startDictatorGame()">🚪 Pay RM140 to Enter Zoo</button>
            </div>

            <div class="navigation-buttons" style="margin-top: 2rem;">
                <button class="btn btn-back" onclick="proceedToSection('demographics')">⬅️ Back</button>
            </div>
        </div>

        <div class="progress-container hidden" id="progress-container">
            <div class="progress-text">Animal <span id="current-animal">1</span> of 14</div>
            <div class="progress-bar">
                <div class="progress-fill" id="game-progress"></div>
            </div>
        </div>

        <div class="section hidden" id="zoo-encounter">
            <div class="zoo-encounter">
                <img id="animal-image" class="animal-image" src="" alt="Animal">
                <h2>🐾 Meet this wonderful animal!</h2>
                <div class="donation-section">
                    <h3>💝 How much would you like to donate?</h3> 
                    <p style="font-size: 1.1rem;">
                        You are now given <strong>10 tokens</strong> to allocate for this animal.<br><br>
                        Use the slider to choose a whole number between <strong>0 and 10</strong>.<br><br>
                        The amount you indicate on the slider will be <strong>given to the animal</strong> for its food and medical care.<br><br>
                    The remaining tokens will be <strong>kept for yourself</strong> and returned to you as cash at the end of the task.</p>

                    <div class="slider-container">
                        <input type="range" min="0" max="10" value="0" class="slider" id="donation-slider">
                        <div class="slider-values">
                            <span>0 tokens</span>
                            <span>10 tokens</span>
                        </div>
                    </div>

                    <div class="donation-display">
                        Amount you spent for the animal: <span id="donation-amount">0 tokens</span><br>
                        Amount left to be refunded: <span id="keep-amount">10 tokens</span>
                    </div>
                </div>

                <button class="btn btn-primary btn-standalone" onclick="nextAnimal()" id="next-animal-btn">Visit the
                    next animal</button>
            </div>

            <div class="navigation-buttons" style="margin-top: 2rem;">
                <button class="btn btn-back" onclick="goBackFromAnimal()">⬅️ Back</button>
            </div>
        </div>

        <div class="section hidden" id="zoo-summary">
            <h1>📊 Your Zoo Visit Summary</h1>
            <div style="text-align: center;">
                <div style="font-size: 4rem; margin: 2rem 0;">🦁🐧🐾🦒</div>
                <h2>🎉 Congratulations! You've visited all 14 animals!</h2>

                <div class="stats-display">
                    <div class="stat-card">
                        <div class="stat-number" id="summary-total-kept">RM 140.00</div>
                        <div class="stat-label">Total Amount to be Refunded</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">14</div>
                        <div class="stat-label">Animals Visited</div>
                    </div>
                </div>

                <div class="highlight">
                    <h3>🔍 What's Next?</h3>
                    <p>Now we'll ask you a few more questions about your experience with the animals.</p>
                    <p>This will help us understand your thoughts about the zoo visit!</p>
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-back" onclick="goBackToZoo()">⬅️ Back to Zoo</button>
                <button class="btn btn-primary" onclick="setupManipulationCheckFromSummary()">✅ Continue</button>
            </div>
        </div>

        <div class="section hidden" id="manipulation-check">
            <h1>⭐ Animal Cuteness Rating</h1>
            <p>Please rate how cute you found each animal on a scale from 1 (not cute at all) to 7 (extremely cute).</p>
            <div id="manipulation-questions"></div>

            <div class="navigation-buttons">
                <button class="btn btn-back" onclick="goBackToZoo()">⬅️ Back to Zoo</button>
                <button class="btn btn-primary" onclick="proceedToSection('attention-check')" id="manipulation-continue"
                    disabled>✅ Continue</button>
            </div>
        </div>

        <div class="section hidden" id="attention-check">
            <h1>🎯 Attention Check</h1>
            <p>Please select all the animals that were presented to you in the zoo visit task. Select as many as you
                think are correct:</p>

            <div class="attention-check-grid">
                <div class="attention-image-item">
                    <img src="https://i.imgur.com/kE9U8g1.png" alt="Animal 1">
                    <label><input type="checkbox" name="attention" value="1"> ✅ I saw this animal</label>
                </div>
                <div class="attention-image-item">
                    <img src="https://i.imgur.com/dig6OlQ.png" alt="Animal 2">
                    <label><input type="checkbox" name="attention" value="2"> ✅ I saw this animal</label>
                </div>
                <div class="attention-image-item">
                    <img src="https://i.imgur.com/xaxASmm.png" alt="Animal 3">
                    <label><input type="checkbox" name="attention" value="3"> ✅ I saw this animal</label>
                </div>
                <div class="attention-image-item">
                    <img src="https://i.imgur.com/JBSsw5g.png" alt="Animal 4">
                    <label><input type="checkbox" name="attention" value="4"> ✅ I saw this animal</label>
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-back" onclick="proceedToSection('manipulation-check')">⬅️ Back</button>
                <button class="btn btn-primary" onclick="proceedToSection('validity-test')" id="attention-continue">🔍
                    Continue</button>
            </div>
        </div>

        <div class="section hidden" id="validity-test">
            <h1>Understanding Check</h1>
            <p>What are the requirements for the task? (Select all that applies)</p>

            <div class="checkbox-group">
                <label><input type="checkbox" name="validity" value="correct1"> The amount that I indicate on the slider
                    is the amount will be given to the animal recipient</label>
                <label><input type="checkbox" name="validity" value="incorrect1"> The amount that I indicate on the
                    slider is the amount that I wish to keep for myself</label>
                <label><input type="checkbox" name="validity" value="incorrect2"> I have 10 tokens to donate throughout
                    the study</label>
                <label><input type="checkbox" name="validity" value="correct2"> I have 10 tokens to donate to each of the
                    animal</label>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-back" onclick="proceedToSection('attention-check')">⬅️ Back</button>
                <button class="btn btn-primary" onclick="proceedToSection('debriefing')"
                    id="validity-continue">Continue</button>
            </div>
        </div>

        <div class="section hidden" id="debriefing">
            <h1>📊 Study Debriefing</h1>
            <p><strong>🙏 Thank you for taking part in this study!</strong></p>
            <p>This research aimed to explore how seeing cute versus non-cute animals might influence prosocial
                behaviour. In this case, how much money you chose to share in each round of the game.</p>

            <div class="highlight">
                <h3>🔍 Important Disclosure:</h3>
                <p>All monetary amounts presented during the task were purely hypothetical. There will be <strong>no
                        real money was involved and you no need to pay anything</strong>.</p>
            </div>

            <p>However, your participation will help advance the current understanding of the effect of cuteness on
                prosocial behaviour.</p>
            <p>We understand that this may cause some discomfort, and we assure you that all data will be kept
                confidential and used strictly for academic purposes. If you feel uncomfortable and wish to withdraw
                your data, you may do so by not submitting this form.</p>
            <p>You have the right to withdraw your participation and request that your data be removed from the study
                without any penalty.</p>
            <p>The use of deception was reviewed and approved by the Ethics Review Board of HELP University. Should you
                have any questions or concerns, or wish to withdraw your participation, please email:</p>

            <div class="info-box">
                <strong>📞 Contact Information:</strong><br>
                <strong>Researcher:</strong> Yong Zi Yu -- B2100815@helplive.edu.my<br>
                <strong>Supervisor:</strong> Ms. Khor Khai Ling -- khailing.k@help.edu.my<br>
                <strong>Ethics Review Board:</strong> psych.erb@help.edu.my
            </div>

            <p><strong>Thank you again for your participation!</strong></p>

            <div class="form-group">
                <label
                    style="font-size: 1.1rem; color: #667eea; background: rgba(103, 126, 234, 0.1); padding: 1rem; border-radius: 10px;">
                    <input type="checkbox" id="final-consent"> ✅ I understand that no real money will be given or
                    received in this study, and I willingly choose to participate in this study
                </label>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-back" onclick="proceedToSection('validity-test')">⬅️ Back</button>
                <button class="btn btn-primary" onclick="completeStudy()" id="complete-study-btn" disabled>🎉 Complete
                    Study</button>
            </div>
        </div>

        <div class="section hidden" id="thank-you">
            <div class="thank-you-page">
                <h1>🙏 Thank You</h1>
                <p style="font-size: 1.3rem;">Thank you for your interest in our research study.</p>
                <p>Your time is valuable, and we appreciate your consideration.</p>
                <div style="font-size: 4rem; margin: 2rem 0;">🦁🐧🐸🦒</div>
            </div>
        </div>

        <div class="section hidden" id="study-complete">
            <div style="text-align: center;">
                <h1>🎉 Study Complete! 🎉</h1>
                <div style="font-size: 4rem; margin: 2rem 0;">🦁🐧🐸🦒🐙🦋</div>
                <div class="success-message">
                    <h2>Thank you for your valuable participation!</h2>
                    <p>Your responses have been recorded successfully and will contribute to important research on
                        cuteness and prosocial behavior.</p>
                    <p><strong>Congratulations, you have finished the study!</strong></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-EqOJoBUbDGpG7e3qxkNLMACTUpOolvl9JM4fc2W8J9WuazBwacOwHL-21NGzlH3-7g/exec';

        const animalImages = [
            "https://i.imgur.com/unjRTSV.png",
            "https://i.imgur.com/xaxASmm.png",
            "https://i.imgur.com/q13LDoX.png",
            "https://i.imgur.com/i2d5sZ5.png",
            "https://i.imgur.com/kE9U8g1.png",
            "https://i.imgur.com/kmrTXme.png",
            "https://i.imgur.com/WOhBZZV.png",
            "https://i.imgur.com/O3hxUdz.png",
            "https://i.imgur.com/dig6OlQ.png",
            "https://i.imgur.com/zIz8RP9.png",
            "https://i.imgur.com/2znBUTL.png",
            "https://i.imgur.com/QUc65Uq.png",
            "https://i.imgur.com/02BYRRJ.png",
            "https://i.imgur.com/MqRuE18.png"
        ];

        let currentAnimalIndex = 0;
        let donations = [];
        let manipulationRatings = [];
        let attentionCheckData = [];
        let validityTestData = [];
        let totalDonated = 0;
        let sectionHistory = [];
        let participantId = null;

        document.addEventListener('DOMContentLoaded', function () {
            participantId = generateParticipantId();
            animateFloatingElements();
            initializeSlider();
            setupEventListeners();
        });

        function generateParticipantId() {
            return Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
        }

        let animationIntervals = []; // Track intervals for cleanup

        function animateFloatingElements() {
            const elements = document.querySelectorAll('.floating-element');

            // Clear any existing intervals
            animationIntervals.forEach(interval => clearInterval(interval));
            animationIntervals = [];

            elements.forEach((element, index) => {
                const intervalId = setInterval(() => {
                    const randomX = Math.random() * (window.innerWidth - 100);
                    const randomY = Math.random() * (window.innerHeight - 100);
                    element.style.transition = 'all 6s ease-in-out';
                    element.style.left = randomX + 'px';
                    element.style.top = randomY + 'px';
                }, 10000 + index * 2000);

                animationIntervals.push(intervalId);
            });
        }

        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', function () {
            animationIntervals.forEach(interval => clearInterval(interval));
        });

        function initializeSlider() {
            const slider = document.getElementById('donation-slider');
            if (slider) {
                slider.addEventListener('input', updateDonationDisplay);
            }
        }

        function setupEventListeners() {
            // Set up final consent checkbox
            setTimeout(() => {
                const finalConsent = document.getElementById('final-consent');
                const completeBtn = document.getElementById('complete-study-btn');
                if (finalConsent && completeBtn) {
                    finalConsent.addEventListener('change', function () {
                        completeBtn.disabled = !this.checked;
                    });
                }
            }, 1000);

            // Set up form validation with race condition protection
            document.addEventListener('change', function (e) {
                // Delay execution to ensure DOM is ready
                setTimeout(() => {
                    if (e.target.name === 'attention') {
                        const anyChecked = document.querySelector('input[name="attention"]:checked');
                        const continueBtn = document.getElementById('attention-continue');
                        if (continueBtn) {
                            continueBtn.disabled = !anyChecked;
                        }
                    }
                    if (e.target.name && e.target.name.startsWith('validity')) {
                        const anyChecked = document.querySelector('input[name="validity"]:checked');
                        const continueBtn = document.getElementById('validity-continue');
                        if (continueBtn) {
                            continueBtn.disabled = !anyChecked;
                        }
                    }
                }, 50);
            });

            // Make sure all buttons are clickable by default
            document.querySelectorAll('.btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.style.pointerEvents = 'auto';
                }
            });
        }

        function proceedToSection(sectionId) {
            const currentSection = document.querySelector('.section:not(.hidden)')?.id;
            if (currentSection && currentSection !== sectionId) {
                sectionHistory.push(currentSection);
            }

            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            if (sectionId === 'zoo-encounter' || sectionId === 'manipulation-check') {
                document.getElementById('progress-container').classList.remove('hidden');
            } else {
                document.getElementById('progress-container').classList.add('hidden');
            }

            window.scrollTo(0, 0);
        }

        function validateDemographics() {
            const age = document.querySelector('input[name="age"]:checked')?.value;
            const vision = document.querySelector('input[name="vision"]:checked')?.value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            const nationality = document.querySelector('input[name="nationality"]:checked')?.value;

            if (!age || !vision || !gender || !nationality) {
                showError('demographics-error', '⚠️ Please answer all demographic questions before continuing.');
                return;
            }

            // Collect demographic data for potential ineligible submission
            const demographicData = { age, vision, gender, nationality };

            const validAges = ['18', '19', '20', '21', '22', '23', '24', '25'];

            // Check eligibility criteria
            if (!validAges.includes(age)) {
                handleIneligible('age_outside_range', demographicData);
                return;
            }

            if (vision === 'uncorrected') {
                handleIneligible('uncorrected_vision', demographicData);
                return;
            }

            if (vision === 'prefer-not-to-say') {
                handleIneligible('vision_prefer_not_say', demographicData);
                return;
            }

            // If eligible, continue to zoo entrance
            proceedToSection('zoo-entrance');
        }

        function startDictatorGame() {
            proceedToSection('zoo-encounter');
            showCurrentAnimal();
        }

        function showCurrentAnimal() {
            const img = document.getElementById('animal-image');
            const animalNumber = document.getElementById('current-animal');
            const slider = document.getElementById('donation-slider');

            // Show loading state
            img.style.opacity = '0.3';
            img.style.transform = 'scale(0.9)';

            // Update progress calculation (including backwards navigation)
            const progress = ((currentAnimalIndex + 1) / animalImages.length) * 100;
            document.getElementById('game-progress').style.width = progress + '%';

            // Set animal number and image
            animalNumber.textContent = currentAnimalIndex + 1;
            img.src = animalImages[currentAnimalIndex];

            // Handle image loading with error fallback
            img.onload = function () {
                this.style.transition = 'all 0.6s ease';
                this.style.transform = 'scale(1)';
                this.style.opacity = '1';
            };

            img.onerror = function () {
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzY2NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkFuaW1hbCBJbWFnZTwvdGV4dD48L3N2Zz4=';
                this.style.transition = 'all 0.6s ease';
                this.style.transform = 'scale(1)';
                this.style.opacity = '1';
            };

            // Reset or restore slider value
            const existingDonation = donations[currentAnimalIndex];
            slider.value = existingDonation ? existingDonation.donation : 0;
            updateDonationDisplay();
        }

        function updateDonationDisplay() {
            const slider = document.getElementById('donation-slider');
            const donationAmount = parseInt(slider.value);
            const keepAmount = 10 - donationAmount;

            const donationText = donationAmount === 1 ? 'token' : 'tokens';
            const keepText = keepAmount === 1 ? 'token' : 'tokens';

            document.getElementById('donation-amount').textContent = `${donationAmount} ${donationText}`;
            document.getElementById('keep-amount').textContent = `${keepAmount} ${keepText}`;
        }

        function nextAnimal() {
            const donationAmount = parseInt(document.getElementById('donation-slider').value);
            donations.push({
                animal: currentAnimalIndex + 1,
                imageUrl: animalImages[currentAnimalIndex],
                donation: donationAmount,
                kept: 10 - donationAmount
            });
            totalDonated += donationAmount;

            currentAnimalIndex++;
            if (currentAnimalIndex >= animalImages.length) {
                showZooSummary();
            } else {
                showCurrentAnimal();
            }
        }

        function showZooSummary() {
            const totalKept = (animalImages.length * 10) - totalDonated;
            document.getElementById('summary-total-kept').textContent = `RM ${totalKept.toFixed(2)}`;
            proceedToSection('zoo-summary');
        }

        function setupManipulationCheckFromSummary() {
            setupManipulationCheck();
            proceedToSection('manipulation-check');
        }

        function setupManipulationCheck() {
            const container = document.getElementById('manipulation-questions');
            container.innerHTML = '';

            animalImages.forEach((imageUrl, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'zoo-encounter';
                questionDiv.style.marginBottom = '3rem';
                questionDiv.innerHTML = `
            <img src="${imageUrl}" class="animal-image" alt="Animal ${index + 1}" style="max-width: 250px; height: 250px;">
            <h3>🌟 How cute is this animal?</h3>
            <div class="likert-scale">
                ${[0, 1, 2, 3, 4, 5, 6, 7].slice(1).map(value => `
                    <div class="likert-item">
                        <input type="radio" name="cuteness-${index}" value="${value}" id="cute-${index}-${value}">
                        <label for="cute-${index}-${value}">
                            ${value === 1 ? 'Not cute<br>at all' :
                        value === 2 ? 'Slightly<br>cute' :
                            value === 3 ? 'Somewhat<br>cute' :
                                value === 4 ? 'Moderately<br>cute' :
                                    value === 5 ? 'Quite<br>cute' :
                                        value === 6 ? 'Very<br>cute' :
                                            'Extremely<br>cute'}
                        </label>
                    </div>
                `).join('')}
            </div>
        `;
                container.appendChild(questionDiv);
            });

            const continueBtn = document.getElementById('manipulation-continue');

            function checkAllAnswered() {
                let allAnswered = true;
                let answeredCount = 0;
                for (let i = 0; i < animalImages.length; i++) {
                    const selected = document.querySelector(`input[name="cuteness-${i}"]:checked`);
                    if (selected) {
                        answeredCount++;
                    } else {
                        allAnswered = false;
                    }
                }
                continueBtn.disabled = !allAnswered;
                continueBtn.textContent = allAnswered
                    ? '✅ Continue'
                    : `✅ Continue (${answeredCount}/${animalImages.length} rated)`;
            }


            container.addEventListener('change', checkAllAnswered);
            checkAllAnswered();
        }


        function goBackFromAnimal() {
            if (currentAnimalIndex > 0) {
                // Don't modify data when going back - just change the view
                const previousIndex = currentAnimalIndex - 1;
                currentAnimalIndex = previousIndex;

                // Restore the previous donation value if it exists
                const previousDonation = donations[previousIndex];
                if (previousDonation) {
                    document.getElementById('donation-slider').value = previousDonation.donation;
                }
                showCurrentAnimal();
            } else {
                proceedToSection('zoo-entrance');
            }
        }

        function goBackToZoo() {
            currentAnimalIndex = animalImages.length - 1;
            proceedToSection('zoo-encounter');
            showCurrentAnimal();
        }

        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.textContent = message;
                container.classList.remove('hidden');
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 5000);
            }
        }

        function collectStudyData() {
            manipulationRatings = [];
            attentionCheckData = Array.from(document.querySelectorAll('input[name="attention"]:checked')).map(el => el.value);
            validityTestData = Array.from(document.querySelectorAll('input[name="validity"]:checked')).map(el => el.value);

            const babyAnimals = [0, 2, 4, 6, 8, 10, 12];
            const adultAnimals = [1, 3, 5, 7, 9, 11, 13];

            let totalBabyDonations = 0;
            let totalAdultDonations = 0;

            donations.forEach((donation, index) => {
                if (babyAnimals.includes(index)) {
                    totalBabyDonations += donation.donation;
                } else {
                    totalAdultDonations += donation.donation;
                }
            });

            // Base study data
            const studyData = {
                date_time: new Date().toISOString(),
                participant_id: participantId,
                age: document.querySelector('input[name="age"]:checked')?.value || '',
                gender: document.querySelector('input[name="gender"]:checked')?.value || '',
                nationality: document.querySelector('input[name="nationality"]:checked')?.value || '',
                vision_condition: document.querySelector('input[name="vision"]:checked')?.value || '',
                animal_1_donation: donations[0]?.donation || 0,
                animal_2_donation: donations[1]?.donation || 0,
                animal_3_donation: donations[2]?.donation || 0,
                animal_4_donation: donations[3]?.donation || 0,
                animal_5_donation: donations[4]?.donation || 0,
                animal_6_donation: donations[5]?.donation || 0,
                animal_7_donation: donations[6]?.donation || 0,
                animal_8_donation: donations[7]?.donation || 0,
                animal_9_donation: donations[8]?.donation || 0,
                animal_10_donation: donations[9]?.donation || 0,
                animal_11_donation: donations[10]?.donation || 0,
                animal_12_donation: donations[11]?.donation || 0,
                animal_13_donation: donations[12]?.donation || 0,
                animal_14_donation: donations[13]?.donation || 0,
                total_adult_donations: totalAdultDonations.toFixed(2),
                total_baby_donations: totalBabyDonations.toFixed(2),
                average_adult_donations: (totalAdultDonations / 7).toFixed(2),
                average_baby_donations: (totalBabyDonations / 7).toFixed(2),
                animal_1_refund: donations[0]?.kept || 10,
                animal_2_refund: donations[1]?.kept || 10,
                animal_3_refund: donations[2]?.kept || 10,
                animal_4_refund: donations[3]?.kept || 10,
                animal_5_refund: donations[4]?.kept || 10,
                animal_6_refund: donations[5]?.kept || 10,
                animal_7_refund: donations[6]?.kept || 10,
                animal_8_refund: donations[7]?.kept || 10,
                animal_9_refund: donations[8]?.kept || 10,
                animal_10_refund: donations[9]?.kept || 10,
                animal_11_refund: donations[10]?.kept || 10,
                animal_12_refund: donations[11]?.kept || 10,
                animal_13_refund: donations[12]?.kept || 10,
                animal_14_refund: donations[13]?.kept || 10,
                total_refund: (140 - totalDonated).toFixed(2),
                study_completion_time: new Date().toISOString(),
                study_duration_minutes: Math.round((Date.now() - studyStartTime) / 60000),
                attention_check_selections: attentionCheckData.join(','),
                validity_test_selections: validityTestData.join(','),
                final_consent_given: document.getElementById('final-consent')?.checked ? 'Yes' : 'No',
                study_completed: 'Yes'
            };

            // 🔥 Flatten cuteness ratings into individual fields
            for (let i = 0; i < animalImages.length; i++) {
                const rating = document.querySelector(`input[name="cuteness-${i}"]:checked`)?.value;
                if (rating) {
                    manipulationRatings.push({
                        animal: i + 1,
                        imageUrl: animalImages[i],
                        cuteness: parseInt(rating, 10)
                    });
                    studyData[`cuteness_rating_animal_${i + 1}`] = parseInt(rating, 10);
                } else {
                    studyData[`cuteness_rating_animal_${i + 1}`] = '';
                }
            }

            return studyData;
        }


        async function submitDataToGoogleSheets(data) {
            const submitBtn = document.getElementById('complete-study-btn');
            const originalText = submitBtn.innerHTML;

            try {
                submitBtn.innerHTML = '<span class="loading-spinner"></span>Saving your data...';
                submitBtn.disabled = true;

                console.log('📤 Submitting data to Google Sheets:', data);

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                console.log('✅ Data submitted successfully');
                return true;

            } catch (error) {
                console.error('❌ Error submitting data:', error);
                submitBtn.innerHTML = '⚠️ Error - Try Again';
                submitBtn.disabled = false;
                showError('debriefing', 'There was an error saving your data. Please try clicking "Complete Study" again. Your responses are still saved locally.');
                return false;
            }
        }

        function handleNonConsent() {
            // Collect basic data for non-consent
            const nonConsentData = {
                date_time: new Date().toISOString(),
                participant_id: participantId,
                consent_status: 'declined',
                reason: 'user_declined_consent',
                age: '',
                gender: '',
                nationality: '',
                vision_condition: '',
                study_completed: 'No - Declined Consent',
                study_duration_minutes: Math.round((Date.now() - studyStartTime) / 60000)
            };

            console.log('📝 Non-consent data to submit:', nonConsentData);

            // Submit the non-consent data and handle response
            submitDataToGoogleSheets(nonConsentData)
                .then(() => {
                    console.log('✅ Non-consent data submitted successfully');
                })
                .catch((error) => {
                    console.error('❌ Failed to submit non-consent data:', error);
                });

            // Show thank you page
            proceedToSection('thank-you');
        }

        function handleIneligible(reason, demographicData = {}) {
            // Collect data for ineligible participants
            const ineligibleData = {
                date_time: new Date().toISOString(),
                participant_id: participantId,
                consent_status: 'consented',
                reason: reason,
                age: demographicData.age || '',
                gender: demographicData.gender || '',
                nationality: demographicData.nationality || '',
                vision_condition: demographicData.vision || '',
                study_completed: 'No - Ineligible',
                study_duration_minutes: Math.round((Date.now() - studyStartTime) / 60000)
            };

            console.log('📝 Ineligible data to submit:', ineligibleData);

            // Submit the ineligible data and handle response
            submitDataToGoogleSheets(ineligibleData)
                .then(() => {
                    console.log('✅ Ineligible data submitted successfully');
                })
                .catch((error) => {
                    console.error('❌ Failed to submit ineligible data:', error);
                });

            // Show thank you page
            proceedToSection('thank-you');
        }

        async function submitDataToGoogleSheets(data) {
            const submitBtn = document.getElementById('complete-study-btn');
            const originalText = submitBtn?.innerHTML;

            try {
                if (submitBtn) {
                    submitBtn.innerHTML = '<span class="loading-spinner"></span>Saving your data...';
                    submitBtn.disabled = true;
                }

                console.log('📤 Submitting data to Google Sheets:', data);
                console.log('🔗 Using URL:', GOOGLE_SCRIPT_URL);

                // Create form data as alternative to JSON
                const formData = new FormData();
                Object.keys(data).forEach(key => {
                    formData.append(key, data[key]);
                });

                // Try fetch with JSON first
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    console.log('✅ JSON submission attempt complete');
                } catch (jsonError) {
                    console.warn('⚠️ JSON submission failed, trying form data:', jsonError);

                    // Fallback to form data
                    try {
                        const formResponse = await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: formData
                        });
                        console.log('✅ Form data submission attempt complete');
                    } catch (formError) {
                        console.error('❌ Both submission methods failed:', formError);
                        throw formError;
                    }
                }

                // Store data locally as backup
                try {
                    const dataKey = `study_backup_${data.participant_id}_${Date.now()}`;
                    const dataString = JSON.stringify(data);
                    // Store in a global variable as localStorage fallback
                    window.studyBackupData = window.studyBackupData || [];
                    window.studyBackupData.push({ key: dataKey, data: data });
                    console.log('💾 Data backed up locally:', dataKey);
                } catch (storageError) {
                    console.warn('⚠️ Local backup failed:', storageError);
                }

                console.log('✅ Data submission process completed');
                return true;

            } catch (error) {
                console.error('❌ Error submitting data:', error);

                // Show user-friendly error
                const errorMsg = 'Unable to save data to server. Data has been backed up locally.';
                alert(errorMsg);
                console.error('Full error details:', error);

                if (submitBtn) {
                    submitBtn.innerHTML = '⚠️ Error - Try Again';
                    submitBtn.disabled = false;
                }
                showError('debriefing', 'There was an error saving your data. Please try clicking "Complete Study" again. Your responses are still saved locally.');
                return false;
            }
        }

        async function completeStudy() {
            const studyData = collectStudyData();
            const submissionSuccess = await submitDataToGoogleSheets(studyData);
            console.log('📊 STUDY COMPLETE - Data Collected:', studyData);
            proceedToSection('study-complete');
        }

        const studyStartTime = Date.now();

        window.addEventListener('beforeunload', function (e) {
            const currentSection = document.querySelector('.section:not(.hidden)')?.id;
            if (currentSection && currentSection !== 'informed-consent' && currentSection !== 'study-complete' && currentSection !== 'thank-you') {
                e.preventDefault();
                e.returnValue = 'You are in the middle of the study. Are you sure you want to leave?';
            }
        });

        function exportStudyDataAsCSV() {
            const data = collectStudyData();
            const csvContent = "data:text/csv;charset=utf-8,"
                + Object.keys(data).join(",") + "\n"
                + Object.values(data).join(",");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `zoo_study_${participantId}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                exportStudyDataAsCSV();
            }
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                console.log('🔍 Current Study Data:', collectStudyData());
            }
        });
    </script>
</body>

</html>

